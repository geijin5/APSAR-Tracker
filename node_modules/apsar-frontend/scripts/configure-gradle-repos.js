#!/usr/bin/env node

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, '..');
const androidDir = join(projectRoot, 'android');

console.log('üîß Configuring Gradle repositories...\n');

if (!existsSync(androidDir)) {
  console.log('‚ö†Ô∏è  Android directory not found. Run "npx cap sync android" first.');
  process.exit(0);
}

// Configure settings.gradle
const settingsGradlePath = join(androidDir, 'settings.gradle');
if (existsSync(settingsGradlePath)) {
  let settingsContent = readFileSync(settingsGradlePath, 'utf8');
  let needsUpdate = false;
  
  // Ensure dependencyResolutionManagement block exists with proper repositories
  if (!settingsContent.includes('dependencyResolutionManagement')) {
    console.log('üìù Adding dependencyResolutionManagement block to settings.gradle...');
    const newBlock = `dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

`;
    settingsContent = newBlock + settingsContent;
    needsUpdate = true;
  } else {
    // Update existing dependencyResolutionManagement block
    const reposBlockRegex = /dependencyResolutionManagement\s*\{[^}]*repositories\s*\{([^}]*)\}/s;
    const match = settingsContent.match(reposBlockRegex);
    
    if (match) {
      const reposContent = match[1];
      let newReposContent = reposContent;
      
      // Ensure google() is first
      if (!reposContent.includes('google()')) {
        console.log('üìù Adding google() repository to settings.gradle...');
        newReposContent = '        google()\n' + newReposContent;
        needsUpdate = true;
      }
      
      // Ensure mavenCentral() exists
      if (!reposContent.includes('mavenCentral()')) {
        console.log('üìù Adding mavenCentral() repository to settings.gradle...');
        newReposContent += '        mavenCentral()\n';
        needsUpdate = true;
      }
      
      // Ensure gradlePluginPortal() exists as fallback
      if (!reposContent.includes('gradlePluginPortal()')) {
        console.log('üìù Adding gradlePluginPortal() repository to settings.gradle...');
        newReposContent += '        gradlePluginPortal()\n';
        needsUpdate = true;
      }
      
      // Reorder to ensure google() is first
      if (newReposContent.includes('google()') && newReposContent.includes('mavenCentral()')) {
        const lines = newReposContent.split('\n').filter(line => line.trim());
        const googleLine = lines.find(line => line.includes('google()'));
        const mavenLine = lines.find(line => line.includes('mavenCentral()'));
        const pluginLine = lines.find(line => line.includes('gradlePluginPortal()'));
        const otherLines = lines.filter(line => 
          !line.includes('google()') && 
          !line.includes('mavenCentral()') && 
          !line.includes('gradlePluginPortal()')
        );
        
        // Reconstruct with google() first, then mavenCentral(), then gradlePluginPortal(), then others
        const orderedLines = [];
        if (googleLine) orderedLines.push(googleLine);
        if (mavenLine) orderedLines.push(mavenLine);
        if (pluginLine) orderedLines.push(pluginLine);
        orderedLines.push(...otherLines);
        
        newReposContent = orderedLines.map(line => line.trim() ? `        ${line.trim()}` : '').join('\n') + '\n';
        needsUpdate = true;
      }
      
      if (needsUpdate) {
        settingsContent = settingsContent.replace(reposBlockRegex, 
          `dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
${newReposContent}    }
}`);
      }
    }
  }
  
  if (needsUpdate) {
    writeFileSync(settingsGradlePath, settingsContent);
    console.log('‚úÖ settings.gradle updated');
  } else {
    console.log('‚úÖ settings.gradle already configured');
  }
} else {
  console.log('‚ö†Ô∏è  settings.gradle not found');
}

// Configure build.gradle (project level)
const buildGradlePath = join(androidDir, 'build.gradle');
if (existsSync(buildGradlePath)) {
  let buildContent = readFileSync(buildGradlePath, 'utf8');
  let needsUpdate = false;
  
  // Update buildscript repositories
  if (buildContent.includes('buildscript')) {
    const buildscriptRegex = /buildscript\s*\{[^}]*repositories\s*\{([^}]*)\}/s;
    const match = buildContent.match(buildscriptRegex);
    
    if (match) {
      const reposContent = match[1];
      if (!reposContent.includes('google()')) {
        console.log('üìù Adding google() to buildscript repositories in build.gradle...');
        buildContent = buildContent.replace(
          buildscriptRegex,
          (fullMatch, repos) => {
            return fullMatch.replace(
              /repositories\s*\{/,
              `repositories {\n        google()\n        mavenCentral()`
            );
          }
        );
        needsUpdate = true;
      }
    }
  }
  
  // Update allprojects repositories
  if (buildContent.includes('allprojects')) {
    const allprojectsRegex = /allprojects\s*\{[^}]*repositories\s*\{([^}]*)\}/s;
    const match = buildContent.match(allprojectsRegex);
    
    if (match) {
      const reposContent = match[1];
      if (!reposContent.includes('google()')) {
        console.log('üìù Adding google() to allprojects repositories in build.gradle...');
        buildContent = buildContent.replace(
          allprojectsRegex,
          (fullMatch, repos) => {
            return fullMatch.replace(
              /repositories\s*\{/,
              `repositories {\n        google()\n        mavenCentral()`
            );
          }
        );
        needsUpdate = true;
      }
    }
  }
  
  if (needsUpdate) {
    writeFileSync(buildGradlePath, buildContent);
    console.log('‚úÖ build.gradle updated');
  } else {
    console.log('‚úÖ build.gradle already configured');
  }
} else {
  console.log('‚ö†Ô∏è  build.gradle not found');
}

// Configure app/build.gradle
const appBuildGradlePath = join(androidDir, 'app', 'build.gradle');
if (existsSync(appBuildGradlePath)) {
  let appBuildContent = readFileSync(appBuildGradlePath, 'utf8');
  
  // Check if there are any repository blocks in app/build.gradle
  if (appBuildContent.includes('repositories')) {
    console.log('üìù Checking app/build.gradle for repositories...');
    // Usually app/build.gradle doesn't have repositories, but if it does, ensure google() is there
    if (appBuildContent.includes('repositories') && !appBuildContent.includes('google()')) {
      appBuildContent = appBuildContent.replace(
        /repositories\s*\{/,
        'repositories {\n        google()\n        mavenCentral()'
      );
      writeFileSync(appBuildGradlePath, appBuildContent);
      console.log('‚úÖ app/build.gradle updated');
    }
  }
}

// Configure gradle.properties
const gradlePropsPath = join(androidDir, 'gradle.properties');
let gradleProps = '';
if (existsSync(gradlePropsPath)) {
  gradleProps = readFileSync(gradlePropsPath, 'utf8');
}

const propertiesToAdd = {
  'org.gradle.jvmargs': '-Xmx2048m -Dfile.encoding=UTF-8',
  'org.gradle.parallel': 'true',
  'org.gradle.caching': 'true',
  'org.gradle.daemon': 'true',
  'systemProp.http.connectionTimeout': '120000',
  'systemProp.http.socketTimeout': '120000',
  'systemProp.http.keepAlive': 'true',
  'systemProp.http.maxConnections': '10',
  'android.useAndroidX': 'true',
  'android.enableJetifier': 'true'
};

let propsUpdated = false;
for (const [key, value] of Object.entries(propertiesToAdd)) {
  const regex = new RegExp(`^${key.replace(/\./g, '\\.')}=.*`, 'm');
  if (!gradleProps.match(regex)) {
    console.log(`üìù Adding ${key} to gradle.properties...`);
    gradleProps += `\n${key}=${value}`;
    propsUpdated = true;
  } else {
    // Update if value is different
    const currentMatch = gradleProps.match(regex);
    if (currentMatch && !currentMatch[0].includes(value)) {
      console.log(`üìù Updating ${key} in gradle.properties...`);
      gradleProps = gradleProps.replace(regex, `${key}=${value}`);
      propsUpdated = true;
    }
  }
}

if (propsUpdated) {
  writeFileSync(gradlePropsPath, gradleProps.trim() + '\n');
  console.log('‚úÖ gradle.properties updated');
} else {
  console.log('‚úÖ gradle.properties already configured');
}

console.log('\n‚úÖ Gradle repositories configured successfully!\n');

