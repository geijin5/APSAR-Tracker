name: Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package.json
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: '12266719'
          accept-android-sdk-licenses: true
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          echo "Installing dependencies..."
          npm install --legacy-peer-deps
          echo "Dependencies installed successfully"
          
          # Verify vite is installed
          echo "Verifying vite installation..."
          if ! npm list vite > /dev/null 2>&1; then
            echo "vite not found, installing explicitly..."
            npm install vite@^5.0.8 --save-dev --legacy-peer-deps
          fi
          
          # Verify vite package exists
          echo "Checking vite package..."
          ls -la node_modules/vite/bin/vite.js 2>/dev/null || echo "Note: vite bin path check"
      
      - name: Build frontend web app
        working-directory: ./frontend
        run: |
          echo "Building frontend..."
          npm run build
          echo "Frontend build completed"
          ls -la dist/ || echo "Build output directory check"
        env:
          NODE_ENV: production
      
      - name: Generate icons
        working-directory: ./frontend
        run: |
          if [ -f "public/logo.png" ]; then
            echo "Generating icons from logo..."
            npm run generate-icons || echo "Icon generation skipped (non-critical)"
          else
            echo "logo.png not found, skipping icon generation"
          fi
        continue-on-error: true
      
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli@6
      
      - name: Initialize Capacitor Android (if needed)
        working-directory: ./frontend
        run: |
          if [ ! -d "android" ]; then
            echo "Android platform not found, initializing..."
            npx cap add android
            if [ ! -d "android" ]; then
              echo "Failed to initialize Android platform, trying alternative method..."
              npx @capacitor/cli add android
            fi
          else
            echo "Android platform already exists"
          fi
          
          # Verify Android platform was created
          if [ ! -d "android" ]; then
            echo "‚ùå Error: Android platform directory not found after initialization"
            exit 1
          fi
          echo "‚úÖ Android platform ready"
      
      - name: Sync Capacitor (copy web assets to Android)
        working-directory: ./frontend
        run: |
          echo "Syncing web assets to Android..."
          npx cap sync android || npx @capacitor/cli sync android
          echo "Sync completed"
          ls -la android/ || echo "Android directory check"
      
      - name: Configure Gradle repositories
        working-directory: ./frontend
        run: |
          if [ -d "android" ]; then
            echo "Configuring Gradle repositories..."
            if node scripts/configure-gradle-repos.js; then
              echo "‚úÖ Repository configuration script completed"
            else
              echo "‚ö†Ô∏è  Repository configuration script had errors, but continuing..."
            fi
            
            # Verify configuration
            echo ""
            echo "üìã Verifying repository configuration..."
            if [ -f "android/settings.gradle" ]; then
              echo "settings.gradle repositories:"
              grep -A 10 "repositories {" android/settings.gradle | head -15 || echo "Could not parse repositories"
            else
              echo "‚ö†Ô∏è  settings.gradle not found"
            fi
            if [ -f "android/gradle.properties" ]; then
              echo ""
              echo "gradle.properties network settings:"
              grep -E "(connectionTimeout|socketTimeout|keepAlive|maxConnections)" android/gradle.properties || echo "No network settings found"
            else
              echo "‚ö†Ô∏è  gradle.properties not found"
            fi
            
            # Check Gradle wrapper
            if [ -f "android/gradlew" ]; then
              echo ""
              echo "‚úÖ Gradle wrapper found"
              chmod +x android/gradlew
              echo "Gradle wrapper version:"
              android/gradlew --version || echo "Could not get Gradle version"
            else
              echo "‚ö†Ô∏è  Gradle wrapper not found in android directory"
            fi
          else
            echo "‚ùå Android directory not found"
            exit 1
          fi
      
      - name: Copy icons to Android (if generated)
        working-directory: ./frontend
        run: |
          if [ -f "public/icon-192.png" ] && [ -d "android/app/src/main/res" ]; then
            echo "Copying icons to Android resources..."
            npm run generate-android-icons || echo "Android icon copy skipped (non-critical)"
          else
            echo "Icons or Android res directory not found, skipping"
          fi
        continue-on-error: true
      
      - name: Accept Android SDK licenses
        run: |
          yes | sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        continue-on-error: true
      
      - name: Verify build environment
        working-directory: ./frontend/android
        run: |
          echo "üîç Build Environment Diagnostics:"
          echo "=================================="
          echo ""
          echo "Java version:"
          java -version || echo "Java not found"
          echo ""
          echo "Android SDK:"
          echo "ANDROID_HOME: $ANDROID_HOME"
          ls -la $ANDROID_HOME 2>/dev/null || echo "ANDROID_HOME not set or invalid"
          echo ""
          echo "Gradle wrapper:"
          if [ -f "./gradlew" ]; then
            ./gradlew --version || echo "Gradle wrapper found but version check failed"
          else
            echo "‚ùå Gradle wrapper not found!"
            exit 1
          fi
          echo ""
          echo "Android project structure:"
          ls -la . 2>/dev/null || echo "Could not list Android directory"
          if [ -f "settings.gradle" ]; then
            echo "‚úÖ settings.gradle exists"
          else
            echo "‚ö†Ô∏è  settings.gradle missing"
          fi
          if [ -f "build.gradle" ]; then
            echo "‚úÖ build.gradle exists"
          else
            echo "‚ö†Ô∏è  build.gradle missing"
          fi
          if [ -d "app" ]; then
            echo "‚úÖ app directory exists"
          else
            echo "‚ö†Ô∏è  app directory missing"
          fi
          echo ""
      
      - name: Build Android APK with retry
        working-directory: ./frontend/android
        run: |
          echo "Building APK with Gradle..."
          chmod +x ./gradlew || true
          
          # Verify Gradle wrapper exists and is executable
          if [ ! -f "./gradlew" ]; then
            echo "‚ùå Gradle wrapper not found!"
            exit 1
          fi
          
          # Retry logic for network issues
          MAX_RETRIES=3
          RETRY_COUNT=0
          BUILD_ERROR=""
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "üî® Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."
            
            # Capture output to file and display
            set +e  # Don't exit on error
            ./gradlew clean assembleDebug --no-daemon --stacktrace --refresh-dependencies 2>&1 | tee gradle-build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
            set -e  # Exit on error again
            
            if [ $BUILD_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ APK build completed successfully"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              # Extract error output
              echo ""
              echo "‚ùå Build failed with exit code: $BUILD_EXIT_CODE"
              echo "Last 100 lines of build output:"
              echo "=========================================="
              tail -100 gradle-build.log 2>/dev/null || cat gradle-build.log
              echo "=========================================="
              
              # Show specific error patterns if found
              if grep -i "403\|forbidden" gradle-build.log > /dev/null 2>&1; then
                echo ""
                echo "‚ö†Ô∏è  Detected 403/Forbidden error - repository access issue"
              fi
              if grep -i "connection\|timeout\|network" gradle-build.log > /dev/null 2>&1; then
                echo ""
                echo "‚ö†Ô∏è  Detected network/connection issue"
              fi
              if grep -i "dependency\|resolve" gradle-build.log > /dev/null 2>&1; then
                echo ""
                echo "‚ö†Ô∏è  Detected dependency resolution issue"
              fi
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo ""
                echo "‚ö†Ô∏è  Retrying in 15 seconds... (Attempt $RETRY_COUNT/$MAX_RETRIES)"
                sleep 15
              else
                echo ""
                echo "‚ùå Build failed after $MAX_RETRIES attempts"
                echo ""
                echo "Common issues to check:"
                echo "  1. Missing dependencies or repositories"
                echo "  2. Java version compatibility (using Java 17)"
                echo "  3. Android SDK version issues"
                echo "  4. Gradle version compatibility"
                echo "  5. Network/repository access issues"
                exit 1
              fi
            fi
          done
      
      - name: Find and verify APK
        working-directory: ./frontend/android
        run: |
          echo "Searching for APK files..."
          find . -name "*.apk" -type f -exec ls -lh {} \;
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "‚úÖ APK found at: app/build/outputs/apk/debug/app-debug.apk"
            ls -lh app/build/outputs/apk/debug/app-debug.apk
          else
            echo "‚ùå APK not found in expected location"
            echo "Searching all locations..."
            find . -name "*.apk" -type f || echo "No APK files found anywhere"
          fi
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apsar-tracker-apk
          path: |
            frontend/android/app/build/outputs/apk/debug/*.apk
            frontend/android/app/build/outputs/apk/**/*.apk
          retention-days: 30
          if-no-files-found: error
